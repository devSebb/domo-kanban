<div class="flex flex-col space-y-4 mx-10">
  <div class="flex justify-between items-center ">
    <div>
      <h1 class="text-2xl font-bold"><%= @board.name %></h1>
      <p class="text-gray-600"><%= @board.description %></p>
    </div>
    <div class="space-x-2">
      <%= link_to "Edit Board", edit_organization_board_path(@board.organization, @board), class: "btn btn-secondary" %>
      <%= link_to "Delete Board", organization_board_path(@board.organization, @board), method: :delete, data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this board?" }, class: "btn btn-danger" %>
    </div>
  </div>

  <div class="mb-4">
    <h2 class="text-xl font-semibold">Create a List</h2>
    <%= form_with model: [@board.organization, @board, @board.lists.build], local: true, class: "flex items-center space-x-2" do |f| %>
      <%= f.text_field :name, placeholder: "List name", class: "form-input" %>
      <%= f.submit "Create List", class: "btn btn-primary" %>
    <% end %>
  </div>

  <div class="flex space-x-4 overflow-x-auto">
    <% @lists.each do |list| %>
      <div class="bg-gray-100 p-4 rounded-lg min-w-[250px]">
        <div class="flex justify-between items-center mb-2">
          <h3 class="font-semibold"><%= list.name %></h3>
          <%= link_to "Delete List", organization_board_list_path(@board.organization, @board, list),
              method: :delete,
              data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this list?" },
              class: "btn btn-danger" %>
          <i class="fas fa-grip-vertical text-gray-400 cursor-move mx-2 drag-handle">Drag</i>
          <button onclick="toggleCardForm('<%= list.id %>')" class="btn btn-sm btn-primary">+</button>
        </div>

        <div id="cardForm<%= list.id %>" class="hidden mb-4">
          <%= form_with(
            model: [list, list.cards.build],
            url: organization_board_list_cards_path(@board.organization, @board, list),
            local: true,
            class: "space-y-2"
          ) do |f| %>
            <%= f.hidden_field :list_id, value: list.id %>
            <%= f.text_field :title, placeholder: "Card title", class: "form-input w-full" %>
            <%= f.text_area :description, placeholder: "Description", class: "form-textarea w-full" %>
            <%= f.datetime_field :due_date, class: "form-input w-full" %>
            <%= f.number_field :position, class: "form-input w-full" %>
            <%= f.collection_select :assigned_user_id, User.all, :id, :email, { prompt: "Assign to user" }, class: "form-select w-full" %>
            <%= f.submit "Create Card", class: "cursor-pointer w-full" %>
          <% end %>
        </div>

        <div class="space-y-2 card-list" data-list-id="<%= list.id %>">
          <% list.cards.order(:position).each do |card| %>
            <div class="card bg-white p-2 rounded shadow" data-card-id="<%= card.id %>">
              <h4 class="font-semibold"><%= card.title %></h4>
              <p class="text-sm text-gray-600"><%= truncate(card.description, length: 50) %></p>
              <p class="text-xs text-gray-500">Due: <%= card.due_date&.strftime("%Y-%m-%d %H:%M") %></p>
              <p class="text-xs text-gray-500">Assigned to: <%= card.assigned_user&.email %></p>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
function toggleCardForm(listId) {
  const form = document.getElementById(`cardForm${listId}`);
  form.classList.toggle('hidden');
}
</script>
